<!DOCTYPE html>
<html>

<head>
    <title>Urban Jungle Events Calendar</title>
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
    <!-- FullCalendar JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <!-- Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Add any custom CSS styles here -->
    <style>
        .event-full {
            pointer-events: none;
            /* Disable click events */
            cursor: default;
            /* Change cursor to default arrow */
        }

        /* FullCalendar overrides if needed */
        .fc-event-title {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <div id="calendar"></div>

    <script>

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(window.location.search);
            return results === null ? null : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Retrieve parameters
        const searchText = getUrlParameter('searchText') || 'Default Search Text';
        const date = getUrlParameter('date') || getCurrentDate();
        const period = getUrlParameter('period') || '1m';

        // Use these parameters in your code
console.log('Search Text:', searchText);
console.log('Date:', date);
console.log('Period:', period);

        // Function to get current date in 'YYYY-MM-DD' format
        function getCurrentDate() {
            const today = new Date();
            return formatDate(today);
        }

        // Function to get date N months from now in 'YYYY-MM-DD' format
        function getDateMonthsFromNow(monthsToAdd = 1) {
            const today = new Date();
            const currentDay = today.getDate();

            // Set date to the first day of the month
            today.setDate(1);
            today.setMonth(today.getMonth() + monthsToAdd);

            // Get the last day of the target month
            const maxDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();

            // Set the date to the original day or the max day, whichever is less
            today.setDate(Math.min(currentDay, maxDay));

            return formatDate(today);
        }

        // Function to format date as 'YYYY-MM-DD'
        function formatDate(date) {
            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);
            return `${year}-${month}-${day}`;
        }

        // Function to add days to a date
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // Function to handle JSONP response
        function jsonpCallback(events) {
            if (events.length === 0) {
                document.getElementById('calendar').innerHTML = '<p>No events found.</p>';
                return;
            }

            // Prepare events for FullCalendar
            const calendarEvents = events.map(event => {
                let eventTitle = event.event_name;
                if (event.event_full) {
                    eventTitle += ' (Full)';
                } else {
                    eventTitle += ' (' + event.spaces_available + ' spots)';
                }

                // Determine the background color based on the event name
                let backgroundColor = event.event_full ? 'gray' : '#ff4709'; // default color

                const eventNameLower = event.event_name.toLowerCase();

                if (eventNameLower.includes('wombats')) {
                    backgroundColor = '#009c6c';
                } else if (eventNameLower.includes('monkeys')) {
                    backgroundColor = '#00a105';
                } else if (eventNameLower.includes('punks')) {
                    backgroundColor = '#527d52';
                } else if (eventNameLower.includes('atp')) {
                    backgroundColor = '#4e4bcc';
                }

                // Set the event URL only if the event is not full
                const eventUrl = event.event_full
                    ? null
                    : 'https://app.clubworx.com/websites/urban-jungle-indoor-rock-climbing-1/calendar/event/' + event.event_id;

                return {
                    title: eventTitle,
                    start: event.event_start_at,
                    end: event.event_end_at,
                    url: eventUrl,
                    backgroundColor: backgroundColor,
                    classNames: event.event_full ? ['event-full'] : [],
                    extendedProps: {
                        eventFull: event.event_full,
                        spacesAvailable: event.spaces_available,
                        location_name: event.location_name,
                        instructor_name: event.instructor_name || 'UJ Team',
                        event_description: event.event_description || null
                    }
                };
            });


            // Calculate the minimum and maximum dates
            const eventDates = events.map(event => new Date(event.event_start_at));
            const minDate = new Date(Math.min.apply(null, eventDates));
            const maxDate = new Date(Math.max.apply(null, eventDates));

            // Initialize FullCalendar with validRange
            initializeCalendar(calendarEvents, minDate, maxDate);
        }

        // Function to initialize the calendar
        function initializeCalendar(calendarEvents, minDate, maxDate) {
            const calendarEl = document.getElementById('calendar');

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'listWeek',
                events: calendarEvents,
                validRange: {
                    start: formatDate(minDate),
                    end: formatDate(addDays(maxDate, 1)) // Add 1 day to include the last event date
                },
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listWeek'
                },
                views: {
                    listWeek: {
                        buttonText: 'List'
                    },
                    dayGridMonth: {
                        buttonText: 'Month'
                    }
                },
                eventClick: function (info) {
                    // Prevent the browser from navigating
                    info.jsEvent.preventDefault();

                    // Open the event URL in a new tab if it exists
                    if (info.event.url) {
                        window.open(info.event.url, '_blank');
                    }
                },

                // Set the first day of the week to Monday
                firstDay: 1,
                // Set the initial date
                initialDate: formatDate(minDate),
                // Customize other FullCalendar options as needed
                eventDidMount: function (info) {
                    const tooltipContent = `
                        <strong>${info.event.title}</strong><br>
                        Location: ${info.event.extendedProps.location_name}<br>
                        Instructor: ${info.event.extendedProps.instructor_name}`;
                    tippy(info.el, {
                        content: tooltipContent,
                        allowHTML: true,
                    });
                },
            });

            calendar.render();
        }

        // Function to load JSONP script
        function loadJsonpScript(url) {
            const script = document.createElement('script');
            script.src = url;
            document.head.appendChild(script);
        }

        // Ensure the DOM is fully loaded before running the script
        document.addEventListener('DOMContentLoaded', function () {
            // const searchText = encodeURIComponent('atp');
            // const date = getCurrentDate(); // Start date
            // const period = '1m'; // 2 months
            const callback = 'jsonpCallback';
            const scriptUrl = 'https://script.google.com/macros/s/AKfycbx79mAIC4UHh3OWMMWMsklKyWniEEHBTVwsVdqFmdCRguncLdNX4Heq9o7F_5wx_mKaLA/exec' +
                '?attribute=jsonp' +
                '&searchText=' + searchText +
                '&date=' + date +
                '&period=' + period +
                '&callback=' + callback;

            // Load the JSONP script
            loadJsonpScript(scriptUrl);
        });
    </script>
</body>

</html>