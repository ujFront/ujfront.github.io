<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVT Scoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">

    <style>
        body {
            position: relative;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
        }

        .app-title {
            font-size: 30px;
            color: #333;
        }

        .session-info {
            text-align: right;
            flex: 1;
            margin: 0 20px;
        }

        .session-date {
            font-size: 14px;
            color: #666;
        }

        /* Student Section */
        .student-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .nav-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #ccc;
        }

        .list-btn {
            width: 45px;
            height: 35px;
            border-radius: 8px;
            background: linear-gradient(135deg, #00b894, #00a085);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .list-btn:hover {
            background: linear-gradient(135deg, #00a085, #00b894);
            transform: scale(1.1);
        }

        .list-btn::before {
            content: '‚â°';
            font-size: 18px;
            font-weight: bold;
        }

        .student-info {
            text-align: left;
        }

        .student-name {
            font-size: 30px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-points {
            font-size: 25px;
            color: #666;
        }

        /* Grade Section */
        .grade-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .grade-row {
            display: flex;
            position: relative;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .grade-row:first-child {
            border-radius: 10px 10px 0 0;
        }

        .grade-row:last-child {
            margin-bottom: 0;
            border-radius: 0 0 10px 10px;
        }

        .grade-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .grade-label {
            width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .grade-label .grade-v {
            font-size: 8em;
            font-weight: bold;
            position: absolute;
            top: 0;
            left: 15px;
            transform: rotate(-15deg);
            opacity: 0.25;
            z-index: 1;
        }

        .grade-label .grade-number {
            font-size: 6em;
            font-weight: bold;
            position: absolute;
            bottom: -10px;
            right: 0;
            z-index: 2;
        }

        .grade-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .grade-row .dismiss-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            font-size: 1.2em;
            color: rgba(0, 0, 0, 0.5);
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 5;
        }

        .grade-row .dismiss-btn:hover {
            color: rgba(0, 0, 0, 0.8);
        }

        .control-row {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            margin-left: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .control-row:last-child {
            border-bottom: none;
        }

        .control-row-label {
            font-size: 1.5em;
            font-weight: bold;
            color: #555;
            opacity: 0.5;
            position: absolute;
            top: 0;
            left: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            justify-content: flex-end;
            margin-top: 8px;
            position: relative;
        }

        .count-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.7);
            color: #333;
            z-index: 3;
        }

        .count-btn.super-btn {
            width: 48px;
            height: 48px;
            font-size: 20px;
            font-weight: 800;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
        }

        .count-btn .btn-number {
            font-size: 11px;
            vertical-align: super;
            position: relative;
            top: -3px;
            margin-left: 2px;
            opacity: 0.9;
        }

        .count-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: #f8f9fa;
        }

        .count-btn.super-btn:hover:not(:disabled) {
            background: #f0f8ff;
            color: #00b894;
        }

        .count-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .count-display {
            font-size: 28px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            background: transparent !important;
            border: none !important;
            padding: 0;
            z-index: 3;
            color: inherit;
        }

        /* Grade gradients & text colours */
        .grade-row.v0 {
            background: linear-gradient(135deg, #a8e6cf, #dcedc1);
            color: #2d3436;
        }

        .grade-row.v1 {
            background: linear-gradient(135deg, #ffd3a5, #fd9853);
            color: #2d3436;
        }

        .grade-row.v2 {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
        }

        .grade-row.v3 {
            background: linear-gradient(135deg, #fab1a0, #e17055);
            color: #2d3436;
        }

        .grade-row.v4 {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: #fff;
        }

        .grade-row.v5 {
            background: linear-gradient(135deg, #fd79a8, #e84393);
            color: #fff;
        }

        .grade-row.v6 {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: #fff;
        }

        .grade-row.v7 {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: #fff;
        }

        .grade-row.v8 {
            background: linear-gradient(135deg, #55a3ff, #2d3436);
            color: #fff;
        }

        .grade-row.v9 {
            background: linear-gradient(135deg, #636e72, #2d3436);
            color: #fff;
        }

        .grade-row.v10 {
            background: linear-gradient(135deg, #2d3436, #000);
            color: #fff;
        }

        /* Keep controls labels visible on darker grades */
        .grade-row.v7 .control-row-label,
        .grade-row.v8 .control-row-label,
        .grade-row.v9 .control-row-label,
        .grade-row.v10 .control-row-label {
            color: #eee;
        }

        /* Climber modal */
        .climber-list {
            max-height: 80vh;
            overflow-y: auto;
        }

        .climber-item {
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .climber-item:hover {
            background-color: #f8f9fa;
        }

        .climber-item.active {
            background-color: var(--bs-primary);
            color: white;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .pending-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1000;
            background: var(--bs-warning-bg-subtle);
            color: var(--bs-warning-text-emphasis);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            display: none;
            animation: pulse 2s infinite;
        }

        .pending-ticks-count {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid var(--bs-warning);
            background: var(--bs-warning-bg-subtle);
            color: #000;
            display: none;
            /* Hidden by default, changes to flex to show */
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 1;
            }
        }

        /* Dark mode overrides */
        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, #212529 0%, #343a40 50%, #495057 100%);
            color: #dee2e6;
        }

        [data-bs-theme="dark"] .app-header,
        [data-bs-theme="dark"] .student-section,
        [data-bs-theme="dark"] .grade-section {
            background: rgba(52, 58, 64, 0.9);
            color: #dee2e6;
        }

        [data-bs-theme="dark"] .grade-row {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        [data-bs-theme="dark"] .grade-row:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        [data-bs-theme="dark"] .grade-controls {
            background: rgba(0, 0, 0, 0.5);
        }

        [data-bs-theme="dark"] .control-row {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        [data-bs-theme="dark"] .control-row-label {
            color: rgba(255, 255, 255, 0.8);
        }

        [data-bs-theme="dark"] .count-btn {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
            color: #dee2e6;
        }

        [data-bs-theme="dark"] .count-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        [data-bs-theme="dark"] .count-btn.super-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #00b894;
        }

        [data-bs-theme="dark"] .count-btn.super-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        [data-bs-theme="dark"] .count-display {
            background: transparent !important;
            color: #dee2e6;
        }

        /* Responsive tweaks */
        @media (max-width: 576px) {
            .app-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .grade-label {
                width: 60px;
                height: 80px;
            }

            .grade-label .grade-number {
                font-size: 32px;
            }

            .grade-label .grade-v {
                font-size: 20px;
            }

            .control-buttons {
                gap: 10px;
            }

            .count-btn,
            .count-btn.super-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }

            .count-display {
                font-size: 20px;
                min-width: 45px;
                padding: 0;
            }

            .control-row {
                padding: 12px 15px;
            }
        }
    </style>

</head>

<body>
    <!-- Theme Toggle -->
    <button class="btn btn-sm btn-outline-secondary theme-toggle" id="themeToggle" title="Toggle Dark Mode">
        üåô
    </button>
    <!-- Pending Changes Indicator -->
    <div class="pending-indicator" id="pendingIndicator">
        ‚è≥ Syncing...
    </div>
    <!-- Grades Management visibility Menu -->
    <button id="manageGradesBtn" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
        data-bs-target="#manageGradesModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5" />
        </svg>
    </button>


    <main class="container">
        <!-- Header -->
        <div class="app-header">
            <div class="app-title">HVT</div>
            <div class="session-info">
                <div id="className">Loading...</div>
                <div class="session-date" id="sessionDate"></div>
            </div>
        </div>

        <!-- Student Section -->
        <div class="student-section">
            <div class="student-header">
                <div class="student-info">
                    <div class="student-name" id="studentName">Select a climber</div>
                    <div class="student-points"><span id="studentPoints">0</span> pts</div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn" id="prevClimber" disabled>‚Äπ</button>
                    <button class="list-btn" id="climberDropdown" data-bs-toggle="modal"
                        data-bs-target="#climberModal"></button>
                    <button class="nav-btn" id="nextClimber" disabled>‚Ä∫</button>
                </div>
            </div>
        </div>

        <!-- Grade Section -->
        <div class="grade-section">
            <div id="gradeRows">
                <!-- Grade rows will be generated here -->
            </div>
        </div>
    </main>

    <!-- Manage Grades Modal -->
    <div class="modal fade" id="manageGradesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Show / Hide Grades</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="gradesForm">
                        <!-- JS will inject a checkbox for each grade here -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Climber Selection Modal -->
    <div class="modal fade" id="climberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Climber</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="climber-list" id="climberList">
                        <!-- Climbers will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script>
        let currentSession = null;
        let climbers = [];
        let currentClimberIndex = -1;
        let selectedClimber = null;
        let climberStats = {};
        let studentGradeCounts = {}; // Store individual grade counts per student
        let pendingChanges = {}; // Track pending changes per student/grade
        let apiCallTimeouts = {}; // Track timeouts for batched API calls
        let hiddenGrades = JSON.parse(localStorage.getItem('hiddenGrades') || '[]');

        // Generate vibrant colors for climber names
        function getClimberColor(index) {
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#e91e63', '#00bcd4',
                '#4caf50', '#ff9800', '#673ab7', '#795548', '#607d8b'
            ];
            return colors[index % colors.length];
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('hvt-theme') || 'light';
            document.body.setAttribute('data-bs-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('hvt-theme', newTheme);
            updateThemeToggle(newTheme);
        }

        function updateThemeToggle(theme) {
            const toggle = document.getElementById('themeToggle');
            toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            toggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        }

        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.style.position = 'fixed';
            alert.style.top = '80px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '1050';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        function showBottomNotification(message, type = 'info') {
            // Remove existing bottom notifications
            const existingNotifications = document.querySelectorAll('.bottom-notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
            notification.className = 'bottom-notification';
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1050;
                font-size: 14px;
                max-width: 400px;
                text-align: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        function updateStudentTotals() {
            if (!selectedClimber) return;

            let totalTops = 0;
            let totalAttempts = 0;

            // Calculate totals from current UI state
            const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];
            grades.forEach(grade => {
                const topsElement = document.getElementById(`${grade}-tops`);
                const attemptsElement = document.getElementById(`${grade}-attempts`);

                if (topsElement && attemptsElement) {
                    totalTops += parseInt(topsElement.textContent) || 0;
                    totalAttempts += parseInt(attemptsElement.textContent) || 0;
                }
            });

            // Update local stats cache
            if (!climberStats[selectedClimber.id]) {
                climberStats[selectedClimber.id] = {};
            }
            climberStats[selectedClimber.id].totalTops = totalTops;
            climberStats[selectedClimber.id].totalAttempts = totalAttempts;
        }

        function updatePendingIndicator() {
            const indicator = document.getElementById('pendingIndicator');

            // Count total pending changes across all students
            let totalPending = 0;
            Object.values(pendingChanges).forEach(studentChanges => {
                Object.values(studentChanges).forEach(gradeChanges => {
                    if (gradeChanges.tops !== 0) totalPending++;
                    if (gradeChanges.attempts !== 0) totalPending++;
                });
            });

            if (totalPending > 0) {
                indicator.style.display = 'block';
                indicator.textContent = `‚è≥ ${totalPending} pending`;
            } else {
                indicator.style.display = 'none';
            }
        }

        function apiCall(action, data = {}) {
            return new Promise((resolve, reject) => {
                const handleResponse = (response) => {
                    if (response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error));
                    }
                };

                switch (action) {
                    case 'getCurrentSession':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiGetCurrentSession();
                        break;
                    case 'logClimb':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiLogClimb(data.studentId, data.grade, data.result, data.count || 1);
                        break;
                    case 'getScoreboard':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiGetScoreboard();
                        break;
                    default:
                        reject(new Error('Unknown action: ' + action));
                }
            });
        }

        async function loadSession() {
            try {
                const response = await apiCall('getCurrentSession');
                currentSession = response.data;

                if (currentSession) {
                    document.getElementById('className').textContent = currentSession.className;
                    document.getElementById('sessionDate').textContent = new Date().toLocaleDateString();

                    climbers = currentSession.students;
                    loadClimberList();
                    createGradeRows();

                    if (climbers.length > 0) {
                        selectClimber(0);
                    }
                } else {
                    document.getElementById('className').textContent = 'No Active Session';
                    document.getElementById('sessionDate').textContent = 'Please start a session first';
                    showAlert('No active session found. Please start a session from the admin panel.', 'warning');
                }
            } catch (error) {
                showAlert('Error loading session: ' + error.message, 'danger');
            }
        }

        function loadClimberList() {
            const climberList = document.getElementById('climberList');
            climberList.innerHTML = '';

            climbers.forEach((climber, index) => {
                const item = document.createElement('div');
                item.className = `climber-item ${index === currentClimberIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <span>${climber.fullName}</span>
                `;
                item.addEventListener('click', () => {
                    selectClimber(index);
                    bootstrap.Modal.getInstance(document.getElementById('climberModal')).hide();
                });
                climberList.appendChild(item);
            });
        }

        function selectClimber(index) {
            if (index < 0 || index >= climbers.length) return;

            currentClimberIndex = index;
            selectedClimber = climbers[index];

            updateClimberDisplay();
            updateNavigationButtons();
            loadStudentGradeCounts();
            loadClimberList();

            // Update stats in background (non-blocking)
            updateClimberStats();
        }

        function initializeStudentGradeCounts(studentId) {
            if (!studentGradeCounts[studentId]) {
                studentGradeCounts[studentId] = {};
                const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];
                grades.forEach(grade => {
                    studentGradeCounts[studentId][grade] = {
                        tops: 0,
                        attempts: 0
                    };
                });
            }

            if (!pendingChanges[studentId]) {
                pendingChanges[studentId] = {};
                const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];
                grades.forEach(grade => {
                    pendingChanges[studentId][grade] = {
                        tops: 0,
                        attempts: 0
                    };
                });
            }
        }

        function ensureStudentGradeInitialized(studentId, grade) {
            if (!studentGradeCounts[studentId]) {
                studentGradeCounts[studentId] = {};
            }
            if (!studentGradeCounts[studentId][grade]) {
                studentGradeCounts[studentId][grade] = { tops: 0, attempts: 0 };
            }

            if (!pendingChanges[studentId]) {
                pendingChanges[studentId] = {};
            }
            if (!pendingChanges[studentId][grade]) {
                pendingChanges[studentId][grade] = { tops: 0, attempts: 0 };
            }
        }

        function loadStudentGradeCounts() {
            if (!selectedClimber) return;

            // Check if we already have data for this student
            const hasExistingData = studentGradeCounts[selectedClimber.id];

            if (hasExistingData) {
                // INSTANT: Display existing data immediately
                displayStudentGradeCounts();
                updateStudentTotals();

                // BACKGROUND: Refresh from server in background
                loadStudentCountsFromServer();
            } else {
                // No existing data - load from server first
                loadStudentCountsFromServer();
            }
        }

        async function loadStudentCountsFromServer() {
            if (!selectedClimber) return;

            const currentStudentId = selectedClimber.id;

            try {
                // Get student's individual grade counts from scoreboard data
                const response = await apiCall('getScoreboard');
                const studentData = response.data.leaderboard.find(s => s.studentId === currentStudentId);

                // Initialize storage structure first
                initializeStudentGradeCounts(currentStudentId);

                if (studentData) {
                    // Update student points from server data
                    climberStats[currentStudentId] = {
                        totalPoints: studentData.totalPoints || 0,
                        totalTops: studentData.tops || 0,
                        totalAttempts: studentData.attempts || 0,
                        efficiency: studentData.efficiency || 0
                    };

                    // Update grade breakdown if available
                    if (studentData.gradeBreakdown) {
                        Object.entries(studentData.gradeBreakdown).forEach(([grade, data]) => {
                            ensureStudentGradeInitialized(currentStudentId, grade);
                            studentGradeCounts[currentStudentId][grade].tops = data.tops || 0;
                            studentGradeCounts[currentStudentId][grade].attempts = data.attempts || 0;
                        });
                    }
                } else {
                    console.warn('No student data found for ID:', currentStudentId);
                }

                // Refresh display only if we're still on the same student
                if (selectedClimber && selectedClimber.id === currentStudentId) {
                    displayStudentGradeCounts();
                    updateStudentTotals();
                }
            } catch (error) {
                console.error('Error loading student grade counts from server:', error);
                // Still initialize with zeros if server fails
                initializeStudentGradeCounts(currentStudentId);
                if (selectedClimber && selectedClimber.id === currentStudentId) {
                    displayStudentGradeCounts();
                    updateStudentTotals();
                }
            }
        }

        function displayStudentGradeCounts() {
            if (!selectedClimber) return;

            // Ensure student data exists
            ensureStudentGradeInitialized(selectedClimber.id, 'V0'); // This will initialize the whole student
            initializeStudentGradeCounts(selectedClimber.id);

            const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];
            grades.forEach(grade => {
                const topsElement = document.getElementById(`${grade}-tops`);
                const attemptsElement = document.getElementById(`${grade}-attempts`);

                if (topsElement && attemptsElement) {
                    // Ensure this specific grade exists
                    ensureStudentGradeInitialized(selectedClimber.id, grade);

                    const counts = studentGradeCounts[selectedClimber.id][grade];
                    topsElement.textContent = counts.tops.toString();
                    attemptsElement.textContent = counts.attempts.toString();

                    // Update pending visual indicators
                    updatePendingVisualIndicators(selectedClimber.id, grade);
                }
            });
        }

        function updateClimberDisplay() {
            if (!selectedClimber) return;

            const nameElement = document.getElementById('studentName');
            nameElement.textContent = selectedClimber.fullName;
            nameElement.style.color = getClimberColor(currentClimberIndex);
            nameElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';

            document.getElementById('studentPoints').textContent =
                (climberStats[selectedClimber.id]?.totalPoints || 0).toFixed(1);
        }

        function updateNavigationButtons() {
            document.getElementById('prevClimber').disabled = currentClimberIndex <= 0;
            document.getElementById('nextClimber').disabled = currentClimberIndex >= climbers.length - 1;
        }

        async function updateClimberStats() {
            if (!selectedClimber) return;

            try {
                const response = await apiCall('getScoreboard');
                const climberData = response.data.leaderboard.find(s => s.studentId === selectedClimber.id);

                if (climberData) {
                    climberStats[selectedClimber.id] = climberData;
                    updateClimberDisplay();
                }
            } catch (error) {
                console.error('Error updating climber stats:', error);
            }
        }

        function createGradeRows() {
            const gradeRows = document.getElementById('gradeRows');
            const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];

            gradeRows.innerHTML = '';

            grades.forEach(grade => {
                const gradeNumber = grade.substring(1);
                const row = document.createElement('div');
                row.className = `grade-row ${grade.toLowerCase()}`;
                row.dataset.grade = gradeNumber;
                row.innerHTML = `
                    <button class="dismiss-btn">&times;</button>
                    <div class="grade-label">
                        <div class="grade-v">V</div>
                        <div class="grade-number">${gradeNumber}</div>
                    </div>
                    <div class="grade-controls">
                        <div class="control-row">
                            <div class="control-row-label">TOP</div>
                            <div class="control-buttons">
                                <div class="pending-ticks-count" id="${grade}-tops-pending"></div>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'tops', 1)">+</button>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'tops', 2)">+<span class="btn-number">2</span></button>
                                <button class="count-btn super-btn" onclick="adjustCount('${grade}', 'tops', 5)">+<span class="btn-number">5</span></button>
                                <div class="count-display" id="${grade}-tops">0</div>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'tops', -1)">-</button>
                            </div>
                        </div>
                        <div class="control-row">
                            <div class="control-row-label">ATT</div>
                            <div class="control-buttons">
                                <div class="pending-ticks-count" id="${grade}-attempts-pending" ></div>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'attempts', 1)">+</button>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'attempts', 2)">+<span class="btn-number">2</span></button>
                                <button class="count-btn super-btn" onclick="adjustCount('${grade}', 'attempts', 5)">+<span class="btn-number">5</span></button>
                                <div class="count-display" id="${grade}-attempts">0</div>
                                <button class="count-btn" onclick="adjustCount('${grade}', 'attempts', -1)">-</button>
                            </div>
                        </div>
                    </div>
                `;
                // hide if previously dismissed
                if (hiddenGrades.includes(gradeNumber)) {
                    row.style.display = 'none';
                }
                gradeRows.appendChild(row);

                // dismiss button handler
                row.querySelector('.dismiss-btn').addEventListener('click', () => {
                    row.style.display = 'none';
                    if (!hiddenGrades.includes(gradeNumber)) {
                        hiddenGrades.push(gradeNumber);
                        localStorage.setItem('hiddenGrades', JSON.stringify(hiddenGrades));
                    }
                });
            });
        }

        // build the Manage Grades form whenever the modal is shown
        document.getElementById('manageGradesModal').addEventListener('show.bs.modal', () => {
            const form = document.getElementById('gradesForm');
            form.innerHTML = '';  // clear old
            const grades = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];
            grades.forEach(g => {
                const id = `chk-grade-${g}`;
                const isChecked = !hiddenGrades.includes(g);
                form.insertAdjacentHTML('beforeend', `
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${g}" id="${id}" ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="${id}">V${g}</label>
              </div>
            `);
                form.querySelector(`#${id}`).addEventListener('change', e => {
                    const grade = e.target.value;
                    const row = document.querySelector(`.grade-row[data-grade="${grade}"]`);
                    if (e.target.checked) {
                        // show
                        row.style.display = 'flex';
                        hiddenGrades = hiddenGrades.filter(h => h !== grade);
                    } else {
                        // hide
                        row.style.display = 'none';
                        if (!hiddenGrades.includes(grade)) hiddenGrades.push(grade);
                    }
                    localStorage.setItem('hiddenGrades', JSON.stringify(hiddenGrades));
                });
            });
        });

        let isOnline = navigator.onLine;

        // Offline handling
        window.addEventListener('online', () => {
            isOnline = true;
            showBottomNotification('Back online - syncing pending changes...', 'info');
            processPendingOperations();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            showBottomNotification('You are offline - changes will sync when reconnected', 'info');
        });

        function processPendingOperations() {
            if (!isOnline) return;

            // Process all pending changes when coming back online
            Object.entries(pendingChanges).forEach(([studentId, studentChanges]) => {
                const student = climbers.find(c => c.id === studentId);
                const studentName = student ? student.fullName : 'Unknown';

                Object.entries(studentChanges).forEach(([grade, gradeChanges]) => {
                    if (gradeChanges.tops !== 0) {
                        executeBatchedApiCall(studentId, studentName, grade, 'tops');
                    }
                    if (gradeChanges.attempts !== 0) {
                        executeBatchedApiCall(studentId, studentName, grade, 'attempts');
                    }
                });
            });
        }

        function adjustCount(grade, type, delta) {
            if (!selectedClimber) {
                showAlert('Please select a climber first', 'warning');
                return;
            }

            const studentId = selectedClimber.id;
            const studentName = selectedClimber.fullName;

            // Initialize if needed
            ensureStudentGradeInitialized(studentId, grade);

            const currentValue = parseInt(document.getElementById(`${grade}-${type}`).textContent);
            const newValue = Math.max(0, currentValue + delta);

            if (newValue === currentValue) return;

            // INSTANT: Update UI immediately
            document.getElementById(`${grade}-${type}`).textContent = newValue;

            // INSTANT: Update local storage
            studentGradeCounts[studentId][grade][type] = newValue;

            // INSTANT: Update pending changes
            pendingChanges[studentId][grade][type] += delta;

            // INSTANT: Update totals and visual indicators
            updateStudentTotals();
            updatePendingVisualIndicators(studentId, grade);
            updatePendingIndicator();

            // BATCHED: Schedule API call with debouncing
            scheduleApiCall(studentId, studentName, grade, type);
        }

        function scheduleApiCall(studentId, studentName, grade, type) {
            const timeoutKey = `${studentId}-${grade}-${type}`;

            // Clear existing timeout for this student/grade/type
            if (apiCallTimeouts[timeoutKey]) {
                clearTimeout(apiCallTimeouts[timeoutKey]);
            }

            // Set new timeout (1 second debounce)
            apiCallTimeouts[timeoutKey] = setTimeout(() => {
                executeBatchedApiCall(studentId, studentName, grade, type);
                delete apiCallTimeouts[timeoutKey];
            }, 1000);
        }

        async function executeBatchedApiCall(studentId, studentName, grade, type) {
            const pendingDelta = pendingChanges[studentId][grade][type];

            if (pendingDelta === 0) {
                updatePendingVisualIndicators(studentId, grade);
                return;
            }

            if (!isOnline) {
                showBottomNotification('Offline - changes will sync when reconnected', 'info');
                return;
            }

            try {
                // Make ONE API call with count parameter (much more reliable!)
                const absDelta = Math.abs(pendingDelta);
                const result = pendingDelta > 0 ?
                    (type === 'tops' ? 'TOP' : 'ATTEMPT') :
                    (type === 'tops' ? 'REMOVE_TOP' : 'REMOVE_ATTEMPT');

                console.log(`üöÄ API Call: ${result} ${grade} for ${studentName}, count: ${absDelta}`);

                await apiCall('logClimb', {
                    studentId: studentId,
                    grade: grade,
                    result: result,
                    count: absDelta
                });

                console.log(`‚úÖ API Success: ${result} ${grade} completed`);

                // Success - clear pending changes
                pendingChanges[studentId][grade][type] = 0;
                updatePendingVisualIndicators(studentId, grade);
                updatePendingIndicator(); // Update global pending indicator

                // Show success notification
                const action = pendingDelta > 0 ?
                    (type === 'tops' ? 'topped' : 'attempted') :
                    (type === 'tops' ? 'removed top from' : 'removed attempt from');
                const deltaText = Math.abs(pendingDelta) > 1 ? ` (+${Math.abs(pendingDelta)})` : '';
                showBottomNotification(`${studentName} ${action} ${grade}${deltaText}`, 'success');

                // Update stats
                setTimeout(() => {
                    updateClimberStats();
                }, 200);

            } catch (error) {
                console.error('Batched API call failed:', error);

                // Clear pending changes even on error to prevent infinite pending state
                // User will see the error message and can retry manually if needed
                pendingChanges[studentId][grade][type] = 0;
                updatePendingVisualIndicators(studentId, grade);
                updatePendingIndicator();

                showBottomNotification(`Failed to sync changes for ${grade} ${type}. Please try again.`, 'error');
            }
        }

        function updatePendingVisualIndicators(studentId, grade) {
            if (!selectedClimber || selectedClimber.id !== studentId) return;

            const topsIndicator = document.getElementById(`${grade}-tops-pending`);
            const attemptsIndicator = document.getElementById(`${grade}-attempts-pending`);

            if (!topsIndicator || !attemptsIndicator) return;

            const topsPending = pendingChanges[studentId][grade].tops;
            const attemptsPending = pendingChanges[studentId][grade].attempts;

            // Update tops indicator
            if (topsPending !== 0) {
                topsIndicator.textContent = `${topsPending > 0 ? '+' : ''}${topsPending}`;
                topsIndicator.style.display = 'flex';
            } else {
                topsIndicator.style.display = 'none';
            }

            // Update attempts indicator
            if (attemptsPending !== 0) {
                attemptsIndicator.textContent = `${attemptsPending > 0 ? '+' : ''}${attemptsPending}`;
                attemptsIndicator.style.display = 'flex';
            } else {
                attemptsIndicator.style.display = 'none';
            }
        }

        // Old executeOperation function removed - now using executeBatchedApiCall

        // Event listeners
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        document.getElementById('prevClimber').addEventListener('click', () => {
            selectClimber(currentClimberIndex - 1);
        });

        document.getElementById('nextClimber').addEventListener('click', () => {
            selectClimber(currentClimberIndex + 1);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                document.getElementById('prevClimber').click();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                document.getElementById('nextClimber').click();
            }
        });


        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadSession();
        });

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (selectedClimber) {
                updateClimberStats();
            }
        }, 30000);
    </script>
</body>

</html>