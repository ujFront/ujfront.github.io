<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVT Scoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
        }

        .app-title {
            font-size: 30px;
            color: #333;
        }

        .session-info {
            text-align: right;
            flex: 1;
            margin: 0 20px;
        }

        .session-date {
            font-size: 14px;
            color: #666;
        }

        /* Student Section */
        .student-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }


        .nav-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: #ccc;
        }

        .list-btn {
            width: 45px;
            height: 35px;
            border-radius: 8px;
            background: linear-gradient(135deg, #00b894, #00a085);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .list-btn:hover {
            background: linear-gradient(135deg, #00a085, #00b894);
            transform: scale(1.1);
        }

        .list-btn::before {
            content: 'â‰¡';
            font-size: 18px;
            font-weight: bold;
        }

        .student-info {
            text-align: left;
        }

        .student-name {
            font-size: 30px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-points {
            font-size: 25px;
            color: #666;
        }

        /* Grade Row */
        .grade-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 10px 0;
        }

        .grade-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 5px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .grade-row:last-child {
            margin-bottom: 0;
        }

        .grade-label {
            font-size: 48px;
            font-weight: bold;
            width: 80px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Grade-specific colors */
        .grade-row.v0 { background: linear-gradient(135deg, #a8e6cf, #dcedc1); }
        .grade-row.v1 { background: linear-gradient(135deg, #ffd3a5, #fd9853); }
        .grade-row.v2 { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }
        .grade-row.v3 { background: linear-gradient(135deg, #fab1a0, #e17055); }
        .grade-row.v4 { background: linear-gradient(135deg, #ff7675, #d63031); }
        .grade-row.v5 { background: linear-gradient(135deg, #fd79a8, #e84393); }
        .grade-row.v6 { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .grade-row.v7 { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .grade-row.v8 { background: linear-gradient(135deg, #55a3ff, #2d3436); }
        .grade-row.v9 { background: linear-gradient(135deg, #636e72, #2d3436); }
        .grade-row.v10 { background: linear-gradient(135deg, #2d3436, #000000); color: white; }
        
        .grade-row.v9 .grade-label, .grade-row.v10 .grade-label {
            color: white;
        }

        .grade-controls {
            display: flex;
            gap: 30px;
            flex: 1;
            justify-content: center;
        }

        .control-group {
            text-align: center;
        }

        .control-label {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #666;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-btn {
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .count-btn.top-btn {
            width: 45px;
            height: 45px;
            background: #dc3545;
            color: white;
            font-size: 18px;
            border-color: #dc3545;
        }
        
        .count-btn.attempt-btn {
            width: 35px;
            height: 35px;
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .count-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .count-btn.top-btn:hover:not(:disabled) {
            background: #c82333;
            border-color: #c82333;
        }
        
        .count-btn.attempt-btn:hover:not(:disabled) {
            background: #5a6268;
            border-color: #5a6268;
        }

        .count-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .count-display {
            font-size: 20px;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        /* Modal */
        .climber-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .climber-item {
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .climber-item:hover {
            background-color: #f8f9fa;
        }

        .climber-item.active {
            background-color: #007bff;
            color: white;
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 50px;
            height: 50px;
        }

        /* Dark mode styles */
        [data-bs-theme="dark"] body {
            background: linear-gradient(135deg, #212529 0%, #343a40 50%, #495057 100%);
            color: #dee2e6;
        }

        [data-bs-theme="dark"] .app-header,
        [data-bs-theme="dark"] .student-section,
        [data-bs-theme="dark"] .grade-section {
            background: rgba(52, 58, 64, 0.9);
            color: #dee2e6;
        }
        
        [data-bs-theme="dark"] .grade-row {
            filter: brightness(0.8);
        }

        /* Responsive */
        @media (max-width: 576px) {
            .app-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .grade-controls {
                gap: 20px;
            }

            .control-buttons {
                gap: 8px;
            }
        }
    </style>
</head>

<body data-bs-theme="light">
    <!-- Theme Toggle -->
    <button class="btn btn-outline-secondary theme-toggle" id="themeToggle" title="Toggle Dark Mode">
        ðŸŒ™
    </button>

    <!-- Climber Selection Modal -->
    <div class="modal fade" id="climberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Climber</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="climber-list" id="climberList">
                        <!-- Climbers will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="app-header">
            <div class="app-title">HVT</div>
            <div class="session-info">
                <div id="className">Loading...</div>
                <div class="session-date" id="sessionDate"></div>
            </div>
        </div>

        <!-- Student Section -->
        <div class="student-section">
            <div class="student-header">
                <div class="student-info">
                    <div class="student-name" id="studentName">Select a student</div>
                    <div class="student-points"><span id="studentPoints">0</span> pts</div>
                </div>
                <div class="nav-controls">
                    <button class="nav-btn" id="prevClimber" disabled>â€¹</button>
                    <button class="list-btn" id="climberDropdown" data-bs-toggle="modal"
                        data-bs-target="#climberModal"></button>
                    <button class="nav-btn" id="nextClimber" disabled>â€º</button>
                </div>
            </div>
        </div>

        <!-- Grade Section -->
        <div class="grade-section">
            <div id="gradeRows">
                <!-- Grade rows will be generated here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSession = null;
        let climbers = [];
        let currentClimberIndex = -1;
        let selectedClimber = null;
        let climberStats = {};
        
        // Generate vibrant colors for climber names
        function getClimberColor(index) {
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#e91e63', '#00bcd4',
                '#4caf50', '#ff9800', '#673ab7', '#795548', '#607d8b'
            ];
            return colors[index % colors.length];
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('hvt-theme') || 'light';
            document.body.setAttribute('data-bs-theme', savedTheme);
            updateThemeToggle(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('hvt-theme', newTheme);
            updateThemeToggle(newTheme);
        }

        function updateThemeToggle(theme) {
            const toggle = document.getElementById('themeToggle');
            toggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            toggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
        }

        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.style.position = 'fixed';
            alert.style.top = '80px';
            alert.style.left = '50%';
            alert.style.transform = 'translateX(-50%)';
            alert.style.zIndex = '1050';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }

        function apiCall(action, data = {}) {
            return new Promise((resolve, reject) => {
                const handleResponse = (response) => {
                    if (response.success) {
                        resolve(response);
                    } else {
                        reject(new Error(response.error));
                    }
                };

                switch (action) {
                    case 'getCurrentSession':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiGetCurrentSession();
                        break;
                    case 'logClimb':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiLogClimb(data.studentId, data.grade, data.result);
                        break;
                    case 'getScoreboard':
                        google.script.run
                            .withSuccessHandler(handleResponse)
                            .withFailureHandler(reject)
                            .apiGetScoreboard();
                        break;
                    default:
                        reject(new Error('Unknown action: ' + action));
                }
            });
        }

        async function loadSession() {
            try {
                const response = await apiCall('getCurrentSession');
                currentSession = response.data;

                if (currentSession) {
                    document.getElementById('className').textContent = currentSession.className;
                    document.getElementById('sessionDate').textContent = new Date().toLocaleDateString();

                    climbers = currentSession.students;
                    loadClimberList();
                    createGradeRows();

                    if (climbers.length > 0) {
                        selectClimber(0);
                    }
                } else {
                    document.getElementById('className').textContent = 'No Active Session';
                    document.getElementById('sessionDate').textContent = 'Please start a session first';
                    showAlert('No active session found. Please start a session from the admin panel.', 'warning');
                }
            } catch (error) {
                showAlert('Error loading session: ' + error.message, 'danger');
            }
        }

        function loadClimberList() {
            const climberList = document.getElementById('climberList');
            climberList.innerHTML = '';

            climbers.forEach((climber, index) => {
                const item = document.createElement('div');
                item.className = `climber-item ${index === currentClimberIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <span>${climber.fullName}</span>
                    <small>${(climberStats[climber.id]?.totalPoints || 0).toFixed(1)} pts</small>
                `;
                item.addEventListener('click', () => {
                    selectClimber(index);
                    bootstrap.Modal.getInstance(document.getElementById('climberModal')).hide();
                });
                climberList.appendChild(item);
            });
        }

        function selectClimber(index) {
            if (index < 0 || index >= climbers.length) return;

            currentClimberIndex = index;
            selectedClimber = climbers[index];

            updateClimberDisplay();
            updateNavigationButtons();
            updateClimberStats();
            loadClimberList();
        }

        function updateClimberDisplay() {
            if (!selectedClimber) return;

            const nameElement = document.getElementById('studentName');
            nameElement.textContent = selectedClimber.fullName;
            nameElement.style.color = getClimberColor(currentClimberIndex);
            nameElement.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
            
            document.getElementById('studentPoints').textContent =
                (climberStats[selectedClimber.id]?.totalPoints || 0).toFixed(1);
        }

        function updateNavigationButtons() {
            document.getElementById('prevClimber').disabled = currentClimberIndex <= 0;
            document.getElementById('nextClimber').disabled = currentClimberIndex >= climbers.length - 1;
        }

        async function updateClimberStats() {
            if (!selectedClimber) return;

            try {
                const response = await apiCall('getScoreboard');
                const climberData = response.data.leaderboard.find(s => s.studentId === selectedClimber.id);

                if (climberData) {
                    climberStats[selectedClimber.id] = climberData;
                    updateClimberDisplay();
                }
            } catch (error) {
                console.error('Error updating climber stats:', error);
            }
        }

        function createGradeRows() {
            const gradeRows = document.getElementById('gradeRows');
            const grades = ['V0', 'V1', 'V2', 'V3', 'V4', 'V5', 'V6', 'V7', 'V8', 'V9', 'V10'];

            gradeRows.innerHTML = '';

            grades.forEach(grade => {
                const row = document.createElement('div');
                row.className = `grade-row ${grade.toLowerCase()}`;
                row.innerHTML = `
                    <div class="grade-label">${grade}</div>
                    <div class="grade-controls">
                        <div class="control-group">
                            <div class="control-label">TOP</div>
                            <div class="control-buttons">
                                <button class="count-btn top-btn" onclick="adjustCount('${grade}', 'tops', 1)">+</button>
                                <div class="count-display" id="${grade}-tops">0</div>
                                <button class="count-btn top-btn" onclick="adjustCount('${grade}', 'tops', -1)">-</button>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="control-label">ATT</div>
                            <div class="control-buttons">
                                <button class="count-btn attempt-btn" onclick="adjustCount('${grade}', 'attempts', 1)">+</button>
                                <div class="count-display" id="${grade}-attempts">0</div>
                                <button class="count-btn attempt-btn" onclick="adjustCount('${grade}', 'attempts', -1)">-</button>
                            </div>
                        </div>
                    </div>
                `;
                gradeRows.appendChild(row);
            });
        }

        async function adjustCount(grade, type, delta) {
            if (!selectedClimber) {
                showAlert('Please select a climber first', 'warning');
                return;
            }

            const currentValue = parseInt(document.getElementById(`${grade}-${type}`).textContent);
            const newValue = Math.max(0, currentValue + delta);

            if (newValue === currentValue) return;

            document.getElementById(`${grade}-${type}`).textContent = newValue;

            if (delta > 0) {
                try {
                    const result = type === 'tops' ? 'TOP' : 'ATTEMPT';
                    await apiCall('logClimb', {
                        studentId: selectedClimber.id,
                        grade: grade,
                        result: result
                    });

                    const action = type === 'tops' ? 'topped' : 'attempted';
                    showAlert(`${selectedClimber.fullName} ${action} ${grade}`, 'success');

                    setTimeout(() => {
                        updateClimberStats();
                    }, 500);

                } catch (error) {
                    document.getElementById(`${grade}-${type}`).textContent = currentValue;
                    showAlert('Error logging climb: ' + error.message, 'danger');
                }
            }
        }

        // Event listeners
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        document.getElementById('prevClimber').addEventListener('click', () => {
            selectClimber(currentClimberIndex - 1);
        });

        document.getElementById('nextClimber').addEventListener('click', () => {
            selectClimber(currentClimberIndex + 1);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                document.getElementById('prevClimber').click();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                document.getElementById('nextClimber').click();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            loadSession();
        });

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            if (selectedClimber) {
                updateClimberStats();
            }
        }, 30000);
    </script>
</body>

</html>